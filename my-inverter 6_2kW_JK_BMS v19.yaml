substitutions:
  device_name: "inverter"
  node_name: "My Inverter"
  inverter_name: "Inverter"
  inverter_tx_pin: GPIO17
  #GPIO5
  inverter_rx_pin: GPIO16
  #GPIO4
  inverter_voltage_offset: "0"
#  pzem_tx_pin: GPIO1
#  pzem_rx_pin: GPIO3
#  pzem_voltage_offset: "0"
#  pzem_current_offset: "0"
  update_interval: 10s # Minimum 10s recommended to avoid duplicate command errors
  select_skip_updates: "6"
  read_skip_updates: "6"
 # pzem_update_interval: 10s # Needs to be 1/5 of update interval because of smoothing filter on pzem readings

  jk_name: BMS
  external_components_source: github://syssi/esphome-jk-bms@main
  mac_address: AA:BB:CC:DD:EE:FF
  # Please use "JK02_24S" if you own a old JK-BMS < hardware version 11.0 (hardware version >= 6.0 and < 11.0)
  # Please use "JK02_32S" if you own a new JK-BMS >= hardware version 11.0 (f.e. JK-B2A8S20P hw 11.XW, sw 11.26)
  # Please use "JK04" if you have some old JK-BMS <= hardware version 3.0 (f.e. JK-B2A16S hw 3.0, sw. 3.3.0)
  protocol_version: JK02_32S


external_components:
  - source: ${external_components_source}
    refresh: 0s


esphome: 
  name: "${device_name}"
  friendly_name: "${node_name}"
  comment: "Monitor and control a PowMR solar inverter via modbus & JK-BMS v15,v19 via bluetooth"
  includes:
    - "helpers"
  project:
    name: "esphome.powmr-hybrid-inverter"
    version: 1.3.5

esp32:
  board: esp32dev
  framework:
    type: esp-idf

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
- platform: esphome
  password: !secret ota_password
  on_begin:
    then:
      - switch.turn_off: ble_client_switch0
      - logger.log: "BLE connection suspended for OTA update"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "My-Inverter Fallback Hotspot"
    password: !secret ap_password

captive_portal:

packages:
  # You can replace next 2 lines with your common configs for all devices
 # common_system: !include includes/common_system.yaml
  common_sensors: !include includes/common_sensors.yaml


#For debug:
#debug:
#  update_interval: 10s

#sensor:
#  - platform: debug
#    free:
#      name: "Heap Free"

logger:
  id: uart_logger
  baud_rate: 0
  level: DEBUG #VERBOSE
  logs:
    esp32_ble_tracker: INFO
    esp32_ble_client: INFO
  # logs:
  #   component: ERROR # Fix for issue #4717 "Component xxxxxx took a long time for an operation"



time:
  - platform: homeassistant
    id: hass_time

web_server:
 port: 80
 local: true
#  ota: false


esp32_ble_tracker:
  scan_parameters:
    active: false

ble_client:
  - mac_address: ${mac_address}
    id: client0

jk_bms_ble:
  - ble_client_id: client0
    protocol_version: ${protocol_version}
    throttle: 5s
    id: bms0
  
uart:
#  - id: uart_pzem
#    baud_rate: 9600
#    tx_pin: ${pzem_tx_pin}
#    rx_pin: ${pzem_rx_pin}
#    debug:
#     direction: BOTH
#     dummy_receiver: false
#     after:
#      delimiter: "\n"
#     sequence:
#      - lambda: UARTDebug::log_string(direction, bytes);

  - id: uart_inverter
    baud_rate: 2400
    tx_pin: ${inverter_tx_pin}
    rx_pin: ${inverter_rx_pin}
    debug:
     direction: BOTH
     dummy_receiver: false
     after:
      delimiter: "\n"
     sequence:
      - lambda: UARTDebug::log_string(direction, bytes);
 
modbus:
  - id: modbus_inverter
    uart_id: uart_inverter
    send_wait_time: 500ms
  
#  - id: modbus_pzem
#    uart_id: uart_pzem
#    send_wait_time: 250ms


modbus_controller:
  - id: smg_inverter
    address: 0x05
    modbus_id: modbus_inverter
    setup_priority: -10
    offline_skip_updates: 100
    #command_throttle: 1s
    update_interval: ${update_interval}
  
#  - id: pzem
    # The current device address.
#    address: 0x02
    # The special address 0xF8 is a broadcast address accepted by any pzem device,
    # so if you use this address, make sure there is only one pzem device connected
    # to the uart bus.
    # address: 0xF8
#    modbus_id: modbus_pzem
#    command_throttle: 0ms
#    setup_priority: -10
#    offline_skip_updates: 100
#    update_interval: ${pzem_update_interval}


button:
  - platform: jk_bms_ble
    retrieve_settings:
      name: "${jk_name} retrieve settings"
    retrieve_device_info:
      name: "${jk_name} retrieve device info"


switch:
  - platform: jk_bms_ble
    charging:
      name: "${jk_name} charging"
    discharging:
      name: "${jk_name} discharging"
    balancer:
      name: "${jk_name} balancer"
    emergency:
      name: "${jk_name} emergency"
    heating:
      name: "${jk_name} heating"
    disable_temperature_sensors:
      name: "${jk_name} disable temperature sensors"
    display_always_on:
      name: "${jk_name} display always on"
    smart_sleep:
      name: "${jk_name} smart sleep"
    disable_pcl_module:
      name: "${jk_name} disable pcl module"
    timed_stored_data:
      name: "${jk_name} timed stored data"
    charging_float_mode:
      name: "${jk_name} charging float mode"

  - platform: ble_client
    ble_client_id: client0
    name: "${jk_name} enable bluetooth connection"
    id: ble_client_switch0


number:
  - platform: jk_bms_ble
    jk_bms_ble_id: bms0
    balance_trigger_voltage:
      name: "${jk_name} balance trigger voltage"
    cell_count:
      name: "${jk_name} cell count"
    total_battery_capacity:
      name: "${jk_name} total battery capacity"
    cell_voltage_overvoltage_protection:
      name: "${jk_name} cell voltage overvoltage protection"
    cell_voltage_overvoltage_recovery:
      name: "${jk_name} cell voltage overvoltage recovery"
    cell_voltage_undervoltage_protection:
      name: "${jk_name} cell voltage undervoltage protection"
    cell_voltage_undervoltage_recovery:
      name: "${jk_name} cell voltage undervoltage recovery"
    balance_starting_voltage:
      name: "${jk_name} balance starting voltage"
    voltage_calibration:
      name: "${jk_name} voltage calibration"
    current_calibration:
      name: "${jk_name} current calibration"
    power_off_voltage:
      name: "${jk_name} power off voltage"
    max_balance_current:
      name: "${jk_name} max balance current"
    max_charge_current:
      name: "${jk_name} max charge current"
    max_discharge_current:
      name: "${jk_name} max discharge current"
    smart_sleep_voltage:
      name: "${jk_name} smart sleep voltage"
    cell_soc100_voltage:
      name: "${jk_name} cell soc100 voltage"
    cell_soc0_voltage:
      name: "${jk_name} cell soc0 voltage"
    cell_request_charge_voltage:
      name: "${jk_name} cell request charge voltage"
    cell_request_float_voltage:
      name: "${jk_name} cell request float voltage"
    cell_request_charge_voltage_time:
      name: "${jk_name} cell request charge voltage time"
    cell_request_float_voltage_time:
      name: "${jk_name} cell request float voltage time"
    charge_overcurrent_protection_delay:
      name: "${jk_name} charge overcurrent protection delay"
    charge_overcurrent_protection_recovery_time:
      name: "${jk_name} charge overcurrent protection recovery time"
    discharge_overcurrent_protection_delay:
      name: "${jk_name} discharge overcurrent protection delay"
    discharge_overcurrent_protection_recovery_time:
      name: "${jk_name} discharge overcurrent protection recovery time"
    short_circuit_protection_delay:
      name: "${jk_name} short circuit protection delay"
    short_circuit_protection_recovery_time:
      name: "${jk_name} short circuit protection recovery time"
    charge_overtemperature_protection:
      name: "${jk_name} charge overtemperature protection"
    charge_overtemperature_protection_recovery:
      name: "${jk_name} charge overtemperature protection recovery"
    discharge_overtemperature_protection:
      name: "${jk_name} discharge overtemperature protection"
    discharge_overtemperature_protection_recovery:
      name: "${jk_name} discharge overtemperature protection recovery"
    charge_undertemperature_protection:
      name: "${jk_name} charge undertemperature protection"
    charge_undertemperature_protection_recovery:
      name: "${jk_name} charge undertemperature protection recovery"
    power_tube_overtemperature_protection:
      name: "${jk_name} power tube overtemperature protection"
    power_tube_overtemperature_protection_recovery:
      name: "${jk_name} power tube overtemperature protection recovery"
    discharge_precharge_time:
      name: "${jk_name} discharge precharge time"
    heating_start_temperature:
      name: "${jk_name} heating start temperature"
    heating_stop_temperature:
      name: "${jk_name} heating stop temperature"

sensor:
#  - platform: pzemac
#    modbus_id: modbus_pzem
#    voltage:
#      name: "Grid Voltage PZEM"
#      id: pzem_grid_voltage
      #internal: true
      #filters:
      #  - &mafilter quantile:
      #      window_size: 5
      #      send_every: 1
      #      send_first_at: 1
      #      quantile: .9
      #  - offset: ${pzem_voltage_offset}
 #   current:
 #     name: "Grid Current PZEM"
 #     id: pzem_grid_current
      #filters:
      #  - *mafilter
      #  - offset: ${pzem_current_offset}
 #   power:
 #     name: "Grid Power PZEM"
 #     id: pzem_grid_power
      #filters:
      #  - *mafilter
 #   power_factor:
 #     name: "Grid Power Factor PZEM"
 #     id: pzem_grid_power_factor
      #filters:
      #  - *mafilter
 #   energy:
 #     name: "Grid Energy PZEM"
 #     id: pzem_grid_energy
      #filters:
      #  - *mafilter

 # - platform: template
 #   name: "Grid Power VA PZEM"
 #   unit_of_measurement: "W"
 #   device_class: power
 #   state_class: measurement
 #   accuracy_decimals: 0
 #   update_interval: ${pzem_update_interval}
 #   lambda: |-
 #     return id(pzem_grid_current).state * id(pzem_grid_voltage).state;

 # - platform: template
 #   name: "Grid Power VA*PF PZEM"
 #   unit_of_measurement: "W"
 #   device_class: power
 #   state_class: measurement
 #   accuracy_decimals: 0
 #   update_interval: ${pzem_update_interval}
 #   lambda: |-
 #     return id(pzem_grid_current).state * id(pzem_grid_voltage).state * id(pzem_grid_power_factor).state;

  - platform: jk_bms_ble
    jk_bms_ble_id: bms0
    min_cell_voltage:
      name: "${jk_name} min cell voltage"
    max_cell_voltage:
      name: "${jk_name} max cell voltage"
    min_voltage_cell:
      name: "${jk_name} min voltage cell"
    max_voltage_cell:
      name: "${jk_name} max voltage cell"
    delta_cell_voltage:
      name: "${jk_name} delta cell voltage"
    average_cell_voltage:
      name: "${jk_name} average cell voltage"
    cell_voltage_1:
      name: "${jk_name} cell voltage 1"
    cell_voltage_2:
      name: "${jk_name} cell voltage 2"
    cell_voltage_3:
      name: "${jk_name} cell voltage 3"
    cell_voltage_4:
      name: "${jk_name} cell voltage 4"
    cell_voltage_5:
      name: "${jk_name} cell voltage 5"
    cell_voltage_6:
      name: "${jk_name} cell voltage 6"
    cell_voltage_7:
      name: "${jk_name} cell voltage 7"
    cell_voltage_8:
      name: "${jk_name} cell voltage 8"
    cell_voltage_9:
      name: "${jk_name} cell voltage 9"
    cell_voltage_10:
      name: "${jk_name} cell voltage 10"
    cell_voltage_11:
      name: "${jk_name} cell voltage 11"
    cell_voltage_12:
      name: "${jk_name} cell voltage 12"
    cell_voltage_13:
      name: "${jk_name} cell voltage 13"
    cell_voltage_14:
      name: "${jk_name} cell voltage 14"
    cell_voltage_15:
      name: "${jk_name} cell voltage 15"
    cell_voltage_16:
      name: "${jk_name} cell voltage 16"
    cell_resistance_1:
      name: "${jk_name} cell resistance 1"
    cell_resistance_2:
      name: "${jk_name} cell resistance 2"
    cell_resistance_3:
      name: "${jk_name} cell resistance 3"
    cell_resistance_4:
      name: "${jk_name} cell resistance 4"
    cell_resistance_5:
      name: "${jk_name} cell resistance 5"
    cell_resistance_6:
      name: "${jk_name} cell resistance 6"
    cell_resistance_7:
      name: "${jk_name} cell resistance 7"
    cell_resistance_8:
      name: "${jk_name} cell resistance 8"
    cell_resistance_9:
      name: "${jk_name} cell resistance 9"
    cell_resistance_10:
      name: "${jk_name} cell resistance 10"
    cell_resistance_11:
      name: "${jk_name} cell resistance 11"
    cell_resistance_12:
      name: "${jk_name} cell resistance 12"
    cell_resistance_13:
      name: "${jk_name} cell resistance 13"
    cell_resistance_14:
      name: "${jk_name} cell resistance 14"
    cell_resistance_15:
      name: "${jk_name} cell resistance 15"
    cell_resistance_16:
      name: "${jk_name} cell resistance 16"
    total_voltage:
      name: "${jk_name} total voltage"
    current:
      name: "${jk_name} current"
    heating_current:
      name: "${jk_name} heating current"
    power:
      name: "${jk_name} power"
    charging_power:
      name: "${jk_name} charging power"
    discharging_power:
      name: "${jk_name} discharging power"
    temperature_sensor_1:
      name: "${jk_name} temperature sensor 1"
    temperature_sensor_2:
      name: "${jk_name} temperature sensor 2"
    temperature_sensor_3:
      name: "${jk_name} temperature sensor 3"
    temperature_sensor_4:
      name: "${jk_name} temperature sensor 4"
    temperature_sensor_5:
      name: "${jk_name} temperature sensor 5"
    power_tube_temperature:
      name: "${jk_name} power tube temperature"
    balancing:
      name: "${jk_name} balancing"
    state_of_charge:
      name: "${jk_name} state of charge"
    state_of_health:
      name: "${jk_name} state of health"
    capacity_remaining:
      name: "${jk_name} capacity remaining"
    total_battery_capacity_setting:
      name: "${jk_name} total battery capacity setting"
    charging_cycles:
      name: "${jk_name} charging cycles"
    total_charging_cycle_capacity:
      name: "${jk_name} total charging cycle capacity"
    total_runtime:
      name: "${jk_name} total runtime"
    balancing_current:
      name: "${jk_name} balancing current"
    errors_bitmask:
      name: "${jk_name} errors bitmask"
    emergency_time_countdown:
      name: "${jk_name} emergency time countdown"
    charge_status_id:
      name: "${jk_name} charge status id"
    charge_status_time_elapsed:
      name: "${jk_name} charge status time elapsed"


  ###################################
  # Read first group (14 registers) #
  ###################################

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Grid Voltage"
    address: 4502
    register_type: holding
    register_count: 14
    force_new_range: true
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      return swapBytes(x);
    filters:
      - multiply: 0.1
     # - offset: ${inverter_voltage_offset}
     # - heartbeat: 10s

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Grid Frequency"
    address: 4503
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      return swapBytes(x);
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    id: PV_Voltage
    name: "${inverter_name} PV Voltage"
    address: 4504
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      return swapBytes(x);
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    id: PV_Power
    name: "${inverter_name} PV Power"
    address: 4505
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
     return swapBytes(x);

  - platform: template
    id: PV_Current
    name: "${inverter_name} PV Current"
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    update_interval: ${update_interval}
    lambda: |-
      if (id(PV_Voltage).state == 0) {
        return 0;
      }
      return id(PV_Power).state / id(PV_Voltage).state;
   # filters:
   #   - heartbeat: 10s

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Battery Voltage"
    id: battery_voltage
    address: 4506
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 2
    lambda: |-
      return swapBytes(x);
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Battery SoC"
    accuracy_decimals: 0
    unit_of_measurement: "%"
    device_class: battery
    address: 4507
    register_type: holding
    value_type: U_WORD
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Battery Charge Current"
    id: battery_charge_current
    address: 4508
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Battery Discharge Current"
    id: battery_discharge_current
    address: 4509
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      return swapBytes(x);

  - platform: template
    name: "${inverter_name} Battery Current"
    id: battery_current
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    update_interval: ${update_interval}
    lambda: |-
      return id(battery_charge_current).state - id(battery_discharge_current).state;
   # filters:
   #   - heartbeat: 10s

  - platform: template
    name: "${inverter_name} Battery Power"
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    update_interval: ${update_interval}
    lambda: |-
      return id(battery_current).state * id(battery_voltage).state;

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Load Voltage"
    id: load_voltage
    address: 4510
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      return swapBytes(x);
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Load Frequency"
    address: 4511
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      return swapBytes(x);
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Load Power VA"
    id: load_Power_VA
    address: 4512
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "VA"
    device_class: apparent_power
    state_class: measurement
    accuracy_decimals: 0
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Load Power"
    id: load_power
    address: 4513
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    lambda: |-
      return swapBytes(x);


  - platform: template
    name: "${inverter_name} Load Current"
    id: load_current
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 3
    update_interval: ${update_interval}
    lambda: |-
      if (id(load_voltage).state == 0) {
        return 0;
      }
      return id(load_Power_VA).state / id(load_voltage).state;


  - platform: template
    name: "${inverter_name} Load Power Factor"
    id: load_power_factor
    device_class: power_factor
    state_class: measurement
    accuracy_decimals: 2
    update_interval: ${update_interval}
    lambda: |-
      if (id(load_power).state == 0) {
        return 0;
      }
      return id(load_power).state / id(load_Power_VA).state;

 

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Load Percent"
    address: 4514
    register_count: 21
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Load Percent2"
    address: 4515
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  # ####################################
  # # Read second group (20 registers) #
  # ####################################


  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4516"
    address: 4516
    skip_updates: ${read_skip_updates}
    #register_count: 20
    force_new_range: true
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4517"
    address: 4517
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4518"
    address: 4518
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4519"
    address: 4519
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);
  
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4520"
    address: 4520
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4521"
    address: 4521
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4522"
    address: 4522
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4523"
    address: 4523
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4524"
    address: 4524
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4525"
    address: 4525
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4526"
    address: 4526
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4527"
    address: 4527
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4528"
    address: 4528
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4529"
    address: 4529
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4530"
    address: 4530
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4531"
    address: 4531
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4532"
    address: 4532
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4533"
    address: 4533
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);


  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4534"
    address: 4534
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);
  
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4535"
    address: 4535
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  # 4535 -> binary

  # 4536 -> text

  # 4537 -> text

  # 4538 -> text
 
  # ####################################
  # # Read third group (22 registers)  #
  # ####################################


  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Charger Source Priority"
    address: 4536
  #  force_new_range: true
  #  register_count: 22
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Output Source Priority"
    address: 4537
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} AC Input Voltage Range"
    address: 4538
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4539"
    address: 4539
    skip_updates: ${read_skip_updates}
    register_type: holding
    value_type: U_WORD
  #  unit_of_measurement: "%"
    device_class: power_factor
    state_class: measurement
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Target Output Frequency"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4540
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Hz"
    lambda: |-
      uint16_t value = swapBytes(x);
      switch (value) {
        case 0: return std::uint16_t(50);
        case 1: return std::uint16_t(60);
        default: return x;
      }

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Max Total Charging Current"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4541
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "A"
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Target Output Voltage"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4542
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Max Utility Charging Current"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4543
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "A"
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Back To Utility Source Voltage"
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4544
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Back To Battery Source Voltage"
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4545
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Bulk Charging Voltage"
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4546
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Floating Charging Voltage"
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4547
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Low CutOff Voltage"
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4548
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Battery Equalization Voltage"
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4549
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Battery Equalized Time"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4550
    register_type: holding
    value_type: U_WORD
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Battery Equalized Timeout"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4551
    register_type: holding
    value_type: U_WORD
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Equalization Interval"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4552
    register_type: holding
    value_type: U_WORD
    lambda: |-
      return swapBytes(x);

  # 4553 -> binary

  # 4554 -> binary

  # 4555 -> text
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4553"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4553
    register_type: holding
    value_type: U_WORD
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Unknown4554"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4554
    register_type: holding
    value_type: U_WORD
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Charger Status"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4555
    register_type: holding
    value_type: U_WORD
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Temperature"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4556
    register_type: holding
    unit_of_measurement: "°C"
    value_type: U_WORD
    lambda: |-
      return swapBytes(x);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Temperature2"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4557
    register_type: holding
    unit_of_measurement: "°C"
    value_type: U_WORD
    lambda: |-
      return swapBytes(x);
      
binary_sensor:
  - platform: jk_bms_ble
    balancing:
      name: "${jk_name} balancing"
    charging:
      name: "${jk_name} charging"
    discharging:
      name: "${jk_name} discharging"
    heating:
      name: "${jk_name} heating"
    online_status:
      name: "${jk_name} online status"
    dry_contact_1:
      name: "${jk_name} dry contact 1"
    dry_contact_2:
      name: "${jk_name} dry contact 2"

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Record Fault Code"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x1

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Battery Equalization"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x2

 #  - platform: modbus_controller
 #    modbus_controller_id: smg_inverter
 #    name: "Equalization Activated Immediately"
 #    entity_category: diagnostic
 #    address: 4535
 #    register_type: holding
 #    bitmask: 0x4

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Alarm"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x100

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Backlight"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x400

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Restart On Overload"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x800

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Restart On Overheat"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x1000

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Beep On Primary Source Fail"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x2000

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Return To Default Screen"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x4000

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Overload Bypass"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x8000

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} On Battery 4553 0x100"
    address: 4553
    register_type: holding
    bitmask: 0x100

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Grid Active 4553 0x200"
    address: 4553
    register_type: holding
    bitmask: 0x200

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Load Off"
    address: 4553
    register_type: holding
    bitmask: 0x1000

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Grid Active 4553 0x2000"
    address: 4553
    register_type: holding
    bitmask: 0x2000

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Load Enabled"
    address: 4553
    register_type: holding
    bitmask: 0x4000

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} On Battery"
    address: 4554
    register_type: holding
    bitmask: 0x1

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Grid Active 4554 0x100"
    id: grid_active2
    address: 4554
    register_type: holding
    bitmask: 0x100

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Grid Active"
    id: grid_active
    address: 4554
    register_type: holding
    bitmask: 0x8000

text_sensor:
  - platform: jk_bms_ble
    errors:
      name: "${jk_name} errors"
    total_runtime_formatted:
      name: "${jk_name} total runtime formatted"
    charge_status:
      name: "${jk_name} charge status"
    software_version:
      name: "${jk_name} software version"
    hardware_version:
      name: "${jk_name} hardware version"

  # ####################################
  # # Read config registers one by one #
  # ####################################

select:
#Menu18 -5002
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 18: Buzzer Alarm"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5002
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1
#Menu6 -5005
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 06: Auto restart when overload"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5005
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1

#Menu7 -5006
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 07: Auto restart when overheat"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5006
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1

#menu22-5007
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 22: Beep On Primary Source Fail"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5007
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1

 #menu23 - 5009
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 23: Overload Bypass"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5009
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1

#menu16 -5017
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    id: charger_source_priority_select
    name: "${inverter_name} Menu 16: Charger Source Priority"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5017
    value_type: U_WORD
    optionsmap:
      "Utility first": 0
      "Solar first": 1
      "Solar and Utility": 2
      "Only Solar": 3
      
#Menu1 -5018
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    id: output_source_priority_select
    name: "${inverter_name} Menu 01: Output Source Priority"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5018
    value_type: U_WORD
    optionsmap:
      "Utility first (USB)": 0
      "Solar first (SUB)": 1
      "SBU priority": 2


#Menu3-5019
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 03: AC Input Voltage"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5019
    value_type: U_WORD
    optionsmap:
      "90-280VAC": 0
      "170-280VAC": 1
#Menu4 -?    
#Menu5 -5020
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 05: Battery Type"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5020
    value_type: U_WORD
    optionsmap:
      "AGM": 0
      "Flooded": 1
      "User Defined": 2     
      "Litium": 3 



#Menu8 -?
#Menu9 -5021 Output frequency  0 - 50hz, 1 - 60hz

#Menu2-5022
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 02: Max Total Charge Current"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5022
    value_type: U_WORD
    optionsmap:
      "10": 10
      "20": 20
      "30": 30
      "40": 40
      "50": 50
      "60": 60
      "70": 70
      "80": 80

#Menu10 -5023 Output voltage (one of 220, 230, 240)

#Menu11 - 5024
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 11: Max Utility Charge Current"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5024
    value_type: U_WORD
    optionsmap:
      "10": 10
      "20": 20
      "30": 30
      "40": 40
      "50": 50
      "60": 60

#Menu12 - 5025
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 12: Back To Utility Source Voltage"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5025
    value_type: U_WORD
    optionsmap:
      "42": 420
      "43": 430
      "44": 440
      "45": 450
      "46": 460
      "47": 470
      "48": 480
      "49": 490
      "50": 500
      "51": 510

#Menu13 - 5026
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "${inverter_name} Menu 13: Back To Battery Source Voltage"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5026
    value_type: U_WORD
    optionsmap:
      "FULL": 0
      "48": 480
      "49": 490
      "50": 500
      "51": 510
      "52": 520
      "53": 530
      "54": 540
      "55": 550
      "56": 560    
      "57": 570
      "58": 580

  #Menu26 - 5027  Bulk charging voltage
  #Menu27 - 5028 Floating charging voltage
  #Menu28 - 5029 Low DC cut-off voltage
  #Menu29 - 5030 Battery equalization voltage
  #Menu33 - 5031 Battery equalized time
  #Menu34 - 5032 Battery equalized timeout
  #Menu35 - 5033 Equalization interval
